{% extends "layout.html" %}
	{% block content %}
	<h1 id='primary_header' align="center">Seldonian Interface GUI</h1>
	<div class="content-section">

		<form method="post" onsubmit="submitFunction()" action="javascript:void(0);">
			{{ setup_form.csrf_token() }}

			<div class="form-group" id="regime">
				{{ setup_form.regime.label }}
				{{ setup_form.regime(class="form-control form-control-lg", onchange="regimeChange(this)") }}
			</div>

			<div class="form-group" id="sub-regime" style="display: block">
				{{ setup_form.sub_regime.label }}
				{{ setup_form.sub_regime(class="form-control form-control-lg",onchange="subregimeChange(this)") }}
			</div>

			<div class="form-group" id="sensitive_attrs" style="display: block">
				{{ setup_form.sensitive_attributes.label }}
				{{ setup_form.sensitive_attributes(class="form-control form-control-lg") }}
			</div>

			<hr class='mt-4 mb-4'>
			<h3 id='constraints' align="center">Build your constraints: </h3>
			<!-- List of base node choices to pick from here -->

			<div class="container" align="center" id="classification_funcs">
				{% set measure_functions = measure_functions_dict['supervised']['classification'] %}

				<div class="variable_group"> 
					<h5>Measure functions:</h5>
					<div class='grid_container'>
						{% for ii in range(measure_functions|length) %}
							{% set measure_function = measure_functions[ii] %}
							<div draggable="true" class="sourcebox">{{measure_function}}</div>
						{% endfor %}
					</div>

					<h5 class='mt-4'>Mathematical operators:</h5>
					<div class='grid_container'>
						{% for ii in range(math_operators|length) %}
							{% set math_operator = math_operators[ii] %}
							<div draggable="true" class="sourcebox">{{math_operator}}</div>
						{% endfor %}
					</div>

					<h5 class='mt-4'>Mathematical functions:</h5>
					<div class='grid_container'>
					{% for ii in range(math_functions|length) %}
						{% set math_function = math_functions[ii] %}
						<div draggable="true" class="sourcebox">{{math_function}}</div>
					{% endfor %}
					</div>

					<h5 class='mt-4'>Constant (editable):</h5>
					<div class='grid_container'>
						<div contentEditable="true" draggable="true" class="sourcebox">1.0</div>
					</div>
				</div>
			</div>

			
			<h3> Drag blocks here:</h3>
			<div class="target_grid_container" id="target_grid_container">
			  <div class="newtargetbox" id="onlynew">Drag block here to add</div>
			  <div class="deletetargetbox" id="onlydelete">Drag block here to remove</div>
			</div>
			
			<div class="form-group" >
				{{ setup_form.submit(class="btn btn-success mt-4") }}
			</div>
		<hr>
		</form>

	</div>

<script>
function regimeChange(regime_field) {
	var regime = regime_field.value;
	let subregime_field = document.getElementById("sub-regime");
	let sensitive_attrs_field = document.getElementById("sensitive_attrs");
	
	if (regime == "supervised") {
		subregime_field.style.display = "block";
		sensitive_attrs_field.style.display = "block";
		var sub_regime = subregime_field.value;
		if (sub_regime == "classification") {
			var measure_functions_field = document.getElementById("classification_funcs");
			var other_measure_functions_field1 = document.getElementById("regression_funcs");
		}
		else {
			var measure_functions_field = document.getElementById("regression_funcs");
			var other_measure_functions_field1 = document.getElementById("classification_funcs");
		}
		var other_measure_functions_field2 = document.getElementById("RL_funcs");

	}

	else {
		var measure_functions_field = document.getElementById("RL_funcs");
		var other_measure_functions_field1 = document.getElementById("classification_funcs");
		var other_measure_functions_field2 = document.getElementById("regression_funcs");
		subregime_field.style.display = "none";
		sensitive_attrs_field.style.display = "none";
	}
	measure_functions_field.style.display = "block"
	other_measure_functions_field1.style.display = "none"
	other_measure_functions_field2.style.display = "none"
	}

function subregimeChange(subregime_field) {
	
	var sub_regime = subregime_field.value;
	if (sub_regime == "classification") {
		var measure_functions_field = document.getElementById("classification_funcs");
		var other_measure_functions_field1 = document.getElementById("regression_funcs");
	}
	else {
		var measure_functions_field = document.getElementById("regression_funcs");
		var other_measure_functions_field1 = document.getElementById("classification_funcs")
	}
	var other_measure_functions_field2 = document.getElementById("RL_funcs");
	
	measure_functions_field.style.display = "block"
	other_measure_functions_field1.style.display = "none"
	other_measure_functions_field2.style.display = "none"
	}

function submitFunction() {

	var csrf_token = "{{ csrf_token() }}";
    var parentDiv = document.getElementById('target_grid_container')
    var childnodes = parentDiv.childNodes;

    var constraintStr = ""
    childnodes.forEach(function(child) {
    	if ((child.tagName == 'DIV') && child.classList.contains("usedtargetbox")) {
    		constraintStr += child.innerHTML
    	}
    });
    // var thediv = $("#target_grid_container").html();

    $.ajax({
            type: 'POST',
            contentType: 'application/json',
            url: '/process_constraints',
            data: JSON.stringify({data:constraintStr}),
            datatype:'json',
            headers: {"X-CSRFToken":csrf_token},
            success: function(data) {
            	window.location = data;
                console.log("success")
            },
            error: function() {
                alert("Oops! Something went wrong.");
            }
    });
  //   $.ajax({
		//   type: "POST",
		//   contentType: "application/json; charset=utf-8",
		//   url: "/process_constraints",
		//   data: JSON.stringify({title: 'hallo', article: 'test'}),
		//   success: function (data) {
		//     console.log(data.title);
		//     console.log(data.article);
		//   },
		//   dataType: "json"
		// });
} 

</script>

<script src="static/js/dragging.js"></script>
 



{% endblock content %}